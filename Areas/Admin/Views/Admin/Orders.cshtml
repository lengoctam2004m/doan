@model IEnumerable<TechStore.Models.Order>

@{
    ViewBag.Title = "Quản lý đơn hàng";
    ViewBag.Message = "Danh sách tất cả đơn hàng trong hệ thống";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4>Danh sách đơn hàng</h4>
                <div class="pull-right">
                    <a href="@Url.Action("Create", "Orders", new { area = "" })" class="btn btn-primary">
                        <i class="glyphicon glyphicon-plus"></i> Tạo đơn hàng mới
                    </a>
                </div>
            </div>
            <div class="panel-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Mã đơn hàng</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt hàng</th>
                                <th>Trạng thái</th>
                                <th>Tổng tiền</th>
                                <th>Ghi chú</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        <strong>#@item.OrderId</strong>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@item.Customer.FullName</strong>
                                            <br><small class="text-muted">@item.Customer.Email</small>
                                            <br><small class="text-muted">@item.Customer.Phone</small>
                                        </div>
                                    </td>
                                    <td>
                                        @item.OrderDate.ToString("dd/MM/yyyy HH:mm")
                                    </td>
                                    <td>
                                        @switch (item.Status)
                                        {
                                            case TechStore.Models.OrderStatus.Pending:
                                                <span class="label label-warning">Chờ xử lý</span>
                                                break;
                                            case TechStore.Models.OrderStatus.Processing:
                                                <span class="label label-info">Đang xử lý</span>
                                                break;
                                            case TechStore.Models.OrderStatus.Shipped:
                                                <span class="label label-primary">Đã giao hàng</span>
                                                break;
                                            case TechStore.Models.OrderStatus.Delivered:
                                                <span class="label label-success">Đã nhận hàng</span>
                                                break;
                                            case TechStore.Models.OrderStatus.Cancelled:
                                                <span class="label label-danger">Đã hủy</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <strong class="text-danger">@item.TotalAmount.ToString("N0") VNĐ</strong>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.Notes))
                                        {
                                            <span title="@item.Notes">@(item.Notes.Length > 30 ? item.Notes.Substring(0, 30) + "..." : item.Notes)</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Không có</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="@Url.Action("Details", "Orders", new { id = item.OrderId, area = "" })" 
                                               class="btn btn-info btn-sm" title="Xem chi tiết">
                                                <i class="glyphicon glyphicon-eye-open"></i>
                                            </a>
                                            <a href="@Url.Action("Edit", "Orders", new { id = item.OrderId, area = "" })" 
                                               class="btn btn-warning btn-sm" title="Sửa">
                                                <i class="glyphicon glyphicon-edit"></i>
                                            </a>
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-toggle="dropdown" title="Cập nhật trạng thái">
                                                    <i class="glyphicon glyphicon-cog"></i> <span class="caret"></span>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a href="#" onclick="updateOrderStatus(@item.OrderId, 1)">Đang xử lý</a></li>
                                                    <li><a href="#" onclick="updateOrderStatus(@item.OrderId, 2)">Đã giao hàng</a></li>
                                                    <li><a href="#" onclick="updateOrderStatus(@item.OrderId, 3)">Đã nhận hàng</a></li>
                                                    <li class="divider"></li>
                                                    <li><a href="#" onclick="updateOrderStatus(@item.OrderId, 4)" class="text-danger">Hủy đơn hàng</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="alert alert-info">
            <h5>Thống kê đơn hàng</h5>
            <ul class="list-inline">
                <li><strong>Tổng đơn hàng:</strong> @Model.Count()</li>
                <li><strong>Chờ xử lý:</strong> @Model.Count(o => o.Status == TechStore.Models.OrderStatus.Pending)</li>
                <li><strong>Đang xử lý:</strong> @Model.Count(o => o.Status == TechStore.Models.OrderStatus.Processing)</li>
                <li><strong>Đã giao hàng:</strong> @Model.Count(o => o.Status == TechStore.Models.OrderStatus.Shipped)</li>
                <li><strong>Đã nhận hàng:</strong> @Model.Count(o => o.Status == TechStore.Models.OrderStatus.Delivered)</li>
                <li><strong>Đã hủy:</strong> @Model.Count(o => o.Status == TechStore.Models.OrderStatus.Cancelled)</li>
            </ul>
        </div>
    </div>
</div>

@section scripts {
    <script>
        function updateOrderStatus(orderId, status) {
            if (confirm('Bạn có chắc chắn muốn cập nhật trạng thái đơn hàng này?')) {
                $.ajax({
                    url: '@Url.Action("UpdateOrderStatus", "Admin")',
                    type: 'POST',
                    data: { orderId: orderId, status: status },
                    success: function (response) {
                        location.reload();
                    },
                    error: function () {
                        alert('Có lỗi xảy ra khi cập nhật trạng thái đơn hàng');
                    }
                });
            }
        }
    </script>
}
